/*
 * HLSPlayerSDK.cpp
 *
 *  Created on: Apr 11, 2014
 *      Author: Mark
 */

#include <jni.h>

#include "HLSDecoder.h"
#include "HLSPlayerSDK.h"


#include <android/native_window.h>
#include <android/native_window_jni.h>



#include "debug.h"
#include "constants.h"

#define CLASS_NAME APP_NAME"::HLSPlayerSDK"


HLSPlayerSDK* gHLSPlayerSDK = NULL;


extern "C"
{
	#define METHOD CLASS_NAME"::Java_com_kaltura_hlsplayersdk_PlayerView_InitNativeDecoder()"
	void Java_com_kaltura_hlsplayersdk_PlayerView_InitNativeDecoder(JNIEnv * env, jobject jcaller)
	{
		if (gHLSPlayerSDK == NULL)
			gHLSPlayerSDK = new HLSPlayerSDK();
		if (gHLSPlayerSDK && gHLSPlayerSDK->GetDecoder() == NULL) gHLSPlayerSDK->CreateDecoder();
	}

	#define METHOD CLASS_NAME"::Java_com_kaltura_hlsplayersdk_PlayerView_CloseNativeDecoder()"
	void Java_com_kaltura_hlsplayersdk_PlayerView_CloseNativeDecoder(JNIEnv* env, jobject jcaller)
	{
		if (gHLSPlayerSDK != NULL)
		{
			gHLSPlayerSDK->Close(env);
			delete gHLSPlayerSDK;
			gHLSPlayerSDK = NULL;
		}
	}

	#define METHOD CLASS_NAME"::Java_com_kaltura_hlsplayersdk_PlayerView_PlayFile()"
	void Java_com_kaltura_hlsplayersdk_PlayerView_PlayFile(JNIEnv* env, jobject jcaller)
	{
		if (gHLSPlayerSDK != NULL)
		{
			gHLSPlayerSDK->PlayFile();
		}
	}

	#define METHOD CLASS_NAME"::Java_com_kaltura_hlsplayersdk_PlayerView_SetSurface()"
	void Java_com_kaltura_hlsplayersdk_PlayerView_SetSurface(JNIEnv* env, jobject jcaller, jobject surface)
	{
		LOGINFO(METHOD, "Entered");
		if (gHLSPlayerSDK != NULL)
		{
			if (gHLSPlayerSDK->GetDecoder() == NULL) gHLSPlayerSDK->CreateDecoder();
			LOGINFO(METHOD, "HLSPlayerSDK is not null");

			gHLSPlayerSDK->GetDecoder()->SetSurface(env, surface);

//			ANativeWindow* window = ANativeWindow_fromSurface(env, surface);
//			LOGINFO(CLASS_NAME, "Java_com_kaltura_hlsplayersdk_PlayerView_SetSurface() - window = %0x", window);
//			if (window)
//			{
//				HLSDecoder* decoder = gHLSPlayerSDK->GetDecoder();
//				if (decoder) decoder->SetNativeWindow(window);
//			}
		}
	}

	#define METHOD CLASS_NAME"::Java_com_kaltura_hlsplayersdk_PlayerView_NextFrame()"
	void Java_com_kaltura_hlsplayersdk_PlayerView_NextFrame(JNIEnv* env, jobject jcaller)
	{
		bool rval = false;
		LOGINFO(METHOD, "Entered");
		if (gHLSPlayerSDK != NULL)
		{
			if (gHLSPlayerSDK->GetDecoder())
			{
				if (gHLSPlayerSDK->GetDecoder()->Update() >= 0) rval = true;
			}

		}
	}

}

#define METHOD CLASS_NAME"::HLSPlayerSDK()"
HLSPlayerSDK::HLSPlayerSDK() : mDecoder(NULL)
{

}

#define METHOD CLASS_NAME"::HLSPlayerSDK()"
HLSPlayerSDK::~HLSPlayerSDK()
{

}

#define METHOD CLASS_NAME"::Close()"
void HLSPlayerSDK::Close(JNIEnv* env)
{
	if (mDecoder != NULL)
	{
		mDecoder->Close(env);
		delete mDecoder;
		mDecoder = NULL;
	}
}

#define METHOD CLASS_NAME"::CreateDecoder()"
bool HLSPlayerSDK::CreateDecoder()
{
	if (!mDecoder)
	{
		mDecoder = new HLSDecoder();
	}

	return mDecoder != NULL;
}

#define METHOD CLASS_NAME"::GetDecoder()"
HLSDecoder* HLSPlayerSDK::GetDecoder()
{
	return mDecoder;
}

#define METHOD CLASS_NAME"::PlayFile()"
void HLSPlayerSDK::PlayFile()
{
	LOGINFO(METHOD, "::PlayFile()");
	if (!mDecoder && !CreateDecoder()) return;

	mDecoder->FeedSegment("/storage/emulated/0/Movies/segment1_0_av.ts");
	mDecoder->FeedSegment("/storage/emulated/0/Movies/segment2_0_av.ts");
	if (mDecoder->Play())
	{
		while (mDecoder->Update() == 0)
		{
			LOGINFO(CLASS_NAME, "Decoded a frame!");
		}
	}
}


